<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Infrastructure Report</title>
</head>

<body
    style="margin: 0; padding: 0; background-color: #f4f4f4; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333333;">

    <table border="0" cellpadding="0" cellspacing="0" width="100%" style="background-color: #f4f4f4;">
        <tr>
            <td align="center" style="padding: 20px 0;">

                <table border="0" cellpadding="0" cellspacing="0" width="100%"
                    style="max-width: 650px; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">

                    <tr>
                        <td height="6" style="background-color: #007bff; font-size: 0; line-height: 0;">&nbsp;</td>
                    </tr>

                    <tr>
                        <td style="padding: 30px 30px 10px 30px;">
                            {% if time_selection == "7d" %}
                            <h2 style="margin: 0; color: #2c3e50; font-size: 24px;">Weekly Infrastructure Report</h2>
                            <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 14px;">Last 7 Days ({{
                                start_date.strftime('%Y-%m-%d') }} - {{ end_date.strftime('%Y-%m-%d') }})</p>
                            {% elif time_selection == "24h" or time_selection == "1d" %}
                            <h2 style="margin: 0; color: #2c3e50; font-size: 24px;">Daily Infrastructure Report</h2>
                            <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 14px;">Last 24 Hours ({{
                                start_date.strftime('%Y-%m-%d') }} - {{ end_date.strftime('%Y-%m-%d') }})</p>
                            {% else %}
                            <h2 style="margin: 0; color: #2c3e50; font-size: 24px;">Custom Infrastructure Report</h2>
                            <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 14px;">{{
                                start_date.strftime('%Y-%m-%d') }} to {{ end_date.strftime('%Y-%m-%d') }}</p>
                            {% endif %}
                        </td>
                    </tr>

                    <tr>
                        <td style="padding: 20px 30px 40px 30px;">

                            <h3
                                style="color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; margin-top: 0;">
                                Server Health</h3>

                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    {% set disk_used = query_prom('sum(node_filesystem_size_bytes{mountpoint="/"}) -
                                    sum(node_filesystem_avail_bytes{mountpoint="/"})') %}
                                    {% set disk_total = query_prom('sum(node_filesystem_size_bytes{mountpoint="/"})') %}
                                    {% set disk_percent = (disk_used / disk_total) * 100 if disk_total > 0 else 0 %}
                                    <td width="48%" align="center"
                                        style="padding: 15px; background-color: #f9f9f9; border-radius: 4px; border: 1px solid #eee;">
                                        <div
                                            style="font-size: 22px; font-weight: bold; color: {% if disk_percent > 85 %}#c0392b{% else %}#2c3e50{% endif %};">
                                            {{ disk_percent | fmt_pct }}
                                        </div>
                                        <div
                                            style="font-size: 11px; text-transform: uppercase; color: #7f8c8d; letter-spacing: 0.5px; margin-top: 5px;">
                                            Disk Usage</div>
                                        <div style="font-size: 10px; color: #999; margin-top: 2px;">Free: {{ (disk_total
                                            - disk_used) | fmt_bytes }}</div>
                                    </td>

                                    <td width="4%"></td> {% set mem_total = query_prom('node_memory_MemTotal_bytes') %}
                                    {% set mem_avail_avg = query_prom('avg_over_time(node_memory_MemAvailable_bytes[' +
                                    time_selection + '])') %}
                                    {% set mem_used_avg = mem_total - mem_avail_avg %}
                                    <td width="48%" align="center"
                                        style="padding: 15px; background-color: #f9f9f9; border-radius: 4px; border: 1px solid #eee;">
                                        <div style="font-size: 22px; font-weight: bold; color: #2c3e50;">
                                            {{ mem_used_avg | fmt_bytes }}
                                        </div>
                                        <div
                                            style="font-size: 11px; text-transform: uppercase; color: #7f8c8d; letter-spacing: 0.5px; margin-top: 5px;">
                                            Avg RAM</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td height="10" colspan="3"></td>
                                </tr>
                                <tr>
                                    <td width="48%" align="center"
                                        style="padding: 15px; background-color: #f9f9f9; border-radius: 4px; border: 1px solid #eee;">
                                        <div style="font-size: 22px; font-weight: bold; color: #2c3e50;">
                                            {{ query_prom('max_over_time(node_load1[' + time_selection + '])') |
                                            round(2) }}
                                        </div>
                                        <div
                                            style="font-size: 11px; text-transform: uppercase; color: #7f8c8d; letter-spacing: 0.5px; margin-top: 5px;">
                                            Max Load (1m)</div>
                                    </td>

                                    <td width="4%"></td>
                                    <td width="48%" align="center"
                                        style="padding: 15px; background-color: #f9f9f9; border-radius: 4px; border: 1px solid #eee;">
                                        <div style="font-size: 22px; font-weight: bold; color: #2c3e50;">
                                            {{ (now - (query_prom('node_boot_time_seconds') | from_epoch)) |
                                            fmt_timedelta }}
                                        </div>
                                        <div
                                            style="font-size: 11px; text-transform: uppercase; color: #7f8c8d; letter-spacing: 0.5px; margin-top: 5px;">
                                            Uptime</div>
                                    </td>
                                </tr>
                            </table>

                            <h3
                                style="color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; margin-top: 30px;">
                                Website Traffic</h3>
                            <table border="0" cellpadding="0" cellspacing="0" width="100%"
                                style="font-size: 14px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th
                                            style="text-align: left; padding: 10px; border-bottom: 2px solid #ddd; color: #555;">
                                            Service</th>
                                        <th
                                            style="text-align: right; padding: 10px; border-bottom: 2px solid #ddd; color: #555;">
                                            Requests</th>
                                        <th
                                            style="text-align: right; padding: 10px; border-bottom: 2px solid #ddd; color: #555;">
                                            Errors (5xx)</th>
                                        <th
                                            style="text-align: right; padding: 10px; border-bottom: 2px solid #ddd; color: #555;">
                                            Success</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for svc in ["backend-contact@docker","backend-projects@docker","frontend@docker"] %}
                                    {% set req_total =
                                    query_prom('sum(increase(traefik_service_requests_total{service="' + svc + '"}[' +
                                    time_selection + ']))') %}
                                    {% set err_total =
                                    query_prom('sum(increase(traefik_service_requests_total{service="' + svc + '",
                                    code=~"5.."}[' + time_selection + ']))') %}

                                    {% set success_rate = 100 %}
                                    {% if req_total > 0 %}
                                    {% set success_rate = 100 - ((err_total / req_total) * 100) %}
                                    {% endif %}

                                    <tr>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee;"><b>{{
                                                svc.replace('@docker', '') }}</b></td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">{{
                                            "{:,.0f}".format(req_total) }}</td>
                                        <td
                                            style="padding: 10px; border-bottom: 1px solid #eee; text-align: right; color: {% if err_total > 0 %}#c0392b{% else %}#27ae60{% endif %}; font-weight: bold;">
                                            {{ "{:,.0f}".format(err_total) }}
                                        </td>
                                        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">
                                            <span
                                                style="color: {% if success_rate < 99 %}#c0392b{% else %}#27ae60{% endif %}; font-weight: bold;">
                                                {{ success_rate | fmt_pct }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <h3
                                style="color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; margin-top: 30px;">
                                Top Metrics</h3>

                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td width="48%" valign="top">
                                        <h4 style="margin: 0 0 10px 0; color: #555; font-size: 14px;">Top Services</h4>
                                        <table border="0" cellpadding="0" cellspacing="0" width="100%"
                                            style="font-size: 13px;">
                                            {% set top_services = query_loki_top('{job="traefik"}',
                                            'traefik_serviceName', 10) %}
                                            {% for svc in top_services %}
                                            <tr>
                                                <td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">{{
                                                    svc.name.replace('@docker', '') }}</td>
                                                <td
                                                    style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;">
                                                    <b>{{ "{:,}".format(svc.count) }}</b></td>
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </td>

                                    <td width="4%"></td>
                                    <td width="48%" valign="top">
                                        <h4 style="margin: 0 0 10px 0; color: #555; font-size: 14px;">Top Hosts</h4>
                                        <table border="0" cellpadding="0" cellspacing="0" width="100%"
                                            style="font-size: 13px;">
                                            {% set top_hosts = query_loki_top('{job="traefik"}', 'traefik_requestHost',
                                            10) %}
                                            {% for host in top_hosts %}
                                            <tr>
                                                <td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;">{{
                                                    host.name }}</td>
                                                <td
                                                    style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;">
                                                    <b>{{ "{:,}".format(host.count) }}</b></td>
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </td>
                                </tr>
                            </table>

                            <h3
                                style="color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; margin-top: 30px;">
                                Traffic Origin</h3>
                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td width="48%" valign="top">
                                        <h4 style="margin: 0 0 10px 0; color: #555; font-size: 14px;">Top Countries</h4>
                                        <table border="0" cellpadding="0" cellspacing="0" width="100%"
                                            style="font-size: 13px;">
                                            {% set countries = query_loki_top('{job="traefik"}',
                                            'traefik_geolite_country_code', 10) %}
                                            {% for c in countries %}
                                            <tr>
                                                <td
                                                    style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; font-family: monospace; font-weight: bold;">
                                                    {{ c.name }}</td>
                                                <td
                                                    style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;">
                                                    <b>{{ "{:,}".format(c.count) }}</b></td>
                                            </tr>
                                            {% else %}
                                            <tr>
                                                <td colspan="2"><i>No Data</i></td>
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </td>

                                    <td width="4%"></td>
                                    <td width="48%" valign="top">
                                        <h4 style="margin: 0 0 10px 0; color: #555; font-size: 14px;">Top Networks</h4>
                                        <table border="0" cellpadding="0" cellspacing="0" width="100%"
                                            style="font-size: 13px;">
                                            {% set asns = query_loki_top('{job="traefik"}',
                                            'traefik_geolite_autonomous_system_organization', 10) %}
                                            {% for org in asns %}
                                            <tr>
                                                <td style="padding: 5px 0; border-bottom: 1px solid #f0f0f0;"
                                                    title="{{ org.name }}">
                                                    {{ org.name[:20] }}{% if org.name|length > 20 %}...{% endif %}
                                                </td>
                                                <td
                                                    style="padding: 5px 0; border-bottom: 1px solid #f0f0f0; text-align: right;">
                                                    <b>{{ "{:,}".format(org.count) }}</b></td>
                                            </tr>
                                            {% else %}
                                            <tr>
                                                <td colspan="2"><i>No Data</i></td>
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </td>
                                </tr>
                            </table>

                            <h3
                                style="color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; margin-top: 30px;">
                                Top System Errors</h3>
                            {% set logs = query_loki('{job="syslog"} |= "error"') %}
                            {% if logs %}
                            <table border="0" cellpadding="0" cellspacing="0" width="100%"
                                style="font-size: 13px; background-color: #fff1f0; border-radius: 4px; border: 1px solid #fabeb9;">
                                {% for l in logs %}
                                <tr>
                                    <td width="40" valign="top"
                                        style="padding: 8px; border-bottom: 1px solid #fadbd8; font-weight: bold; color: #c0392b;">
                                        {{ l.count }}x</td>
                                    <td
                                        style="padding: 8px; border-bottom: 1px solid #fadbd8; color: #c0392b; font-family: monospace;">
                                        {{ l.message }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                            {% else %}
                            <table border="0" cellpadding="0" cellspacing="0" width="100%"
                                style="font-size: 13px; background-color: #f0f0f0; border-radius: 4px; border: 1px solid #d6e9c6;">
                                <tr>
                                    <td style="padding: 10px; color: #27ae60;"><i>No system errors found in the selected
                                            time range.</i></td>
                                </tr>
                            </table>
                            {% endif %}

                            <h3
                                style="color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; margin-top: 30px;">
                                Fail2Ban Activity</h3>
                            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="font-size: 14px;">
                                <tr style="background-color: #f8f9fa;">
                                    <th style="text-align: left; padding: 8px; color: #666;">Jail</th>
                                    <th style="text-align: right; padding: 8px; color: #666;">Fails</th>
                                    <th style="text-align: right; padding: 8px; color: #666;">Bans</th>
                                </tr>
                                {% set f2b_stats = (query_prom_raw('f2b_jail_failed_total') | list |
                                sort(attribute='value', reverse=True)) %}
                                {% for stat in f2b_stats %}
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ stat.metric.jail }}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">{{
                                        "{:,}".format(stat.value[1]|int) }}</td>
                                    {% set bans = query_prom_raw('f2b_jail_banned_total{jail="' + stat.metric.jail +
                                    '"}') %}
                                    <td
                                        style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">
                                        {{ "{:,}".format(bans[0].value[1]|int) if bans else "0" }}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" style="padding: 10px;"><i>No Fail2Ban data.</i></td>
                                </tr>
                                {% endfor %}
                            </table>

                            <h3
                                style="color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 18px; margin-top: 30px;">
                                Backup Status</h3>
                            {% set last_backup = query_prom('max_over_time(resticprofile_backup_time_seconds[' +
                            time_selection + '])') | from_epoch %}
                            {% set backup_status = query_prom('last_over_time(resticprofile_backup_status[' +
                            time_selection + '])') %}

                            <table border="0" cellpadding="0" cellspacing="0" width="100%">
                                <tr>
                                    <td width="30%" align="center"
                                        style="padding: 15px; border-radius: 4px; border: 1px solid #eee; background-color: {% if backup_status == 2 %}#e8f8f5{% else %}#fdedec{% endif %};">
                                        <div
                                            style="font-size: 16px; font-weight: bold; color: {% if backup_status == 2 %}#27ae60{% else %}#c0392b{% endif %};">
                                            {% if backup_status == 2 %}SUCCESS{% else %}FAILED{% endif %}
                                        </div>
                                        <div
                                            style="font-size: 10px; text-transform: uppercase; color: #666; margin-top: 5px;">
                                            Last Status</div>
                                    </td>
                                    <td width="5%"></td>
                                    <td width="30%" align="center"
                                        style="padding: 15px; border-radius: 4px; border: 1px solid #eee; background-color: #f9f9f9;">
                                        <div style="font-size: 14px; font-weight: bold; color: #333;">
                                            {{ last_backup.strftime('%Y-%m-%d %H:%M') if last_backup else 'N/A' }}
                                        </div>
                                        <div
                                            style="font-size: 10px; text-transform: uppercase; color: #666; margin-top: 5px;">
                                            Last Run</div>
                                    </td>
                                    <td width="5%"></td>
                                    {% set processed_bytes =
                                    query_prom('last_over_time(resticprofile_backup_processed_bytes[' + time_selection +
                                    '])') %}
                                    <td width="30%" align="center"
                                        style="padding: 15px; border-radius: 4px; border: 1px solid #eee; background-color: #f9f9f9;">
                                        <div style="font-size: 14px; font-weight: bold; color: #333;">
                                            {{ processed_bytes | fmt_bytes if processed_bytes else 'N/A' }}
                                        </div>
                                        <div
                                            style="font-size: 10px; text-transform: uppercase; color: #666; margin-top: 5px;">
                                            Size</div>
                                    </td>
                                </tr>
                            </table>

                            <div style="margin-top: 15px;">
                                <div
                                    style="background-color: #f0f0f0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; color: #555; max-height: 150px; overflow-y: auto;">
                                    {% set backup_logs = query_loki_raw('{job="resticprofile"}', limit=50) %}
                                    {% if backup_logs %}
                                    {% for log in backup_logs %}{{ log.message }}<br>{% endfor %}
                                    {% else %}
                                    No recent backup logs found.
                                    {% endif %}
                                </div>
                            </div>

                        </td>
                    </tr>

                    <tr>
                        <td align="center"
                            style="background-color: #f8f9fa; padding: 20px; border-top: 1px solid #eeeeee; color: #999999; font-size: 12px;">
                            Generated by Python Auto-Reporter â€¢ {{ start_date.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                    </tr>

                </table>
            </td>
        </tr>
    </table>
</body>

</html>